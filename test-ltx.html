<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LTX Video Test</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background: #4F46E5;
      color: white;
      border: none;
      border-radius: 8px;
      margin: 10px 0;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #log {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    input[type="file"] {
      margin: 10px 0;
    }
    video {
      max-width: 100%;
      margin-top: 20px;
      border: 2px solid #4F46E5;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>ğŸ¬ LTX Video API í…ŒìŠ¤íŠ¸</h1>

  <div>
    <label>ì´ë¯¸ì§€ ì„ íƒ: <input type="file" id="imageInput" accept="image/*"></label>
  </div>

  <div>
    <label>
      ëŒ€ì‚¬ ì…ë ¥:<br>
      <textarea id="dialogueInput" style="width: 100%; height: 60px; margin-top: 5px;">ì•ˆë…•í•˜ì„¸ìš”, ë°˜ê°‘ìŠµë‹ˆë‹¤!</textarea>
    </label>
  </div>

  <button id="testBtn" disabled>LTX ë¹„ë””ì˜¤ ìƒì„± í…ŒìŠ¤íŠ¸</button>

  <div id="log">ì¤€ë¹„ ì¤‘...</div>

  <video id="resultVideo" controls style="display:none;"></video>

  <script type="module">
    const MODAL_API = 'https://hiyoonsh1--ltx-video-service-v2-web-app.modal.run';
    const GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';

    const log = (msg) => {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logEl.textContent += `[${timestamp}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    };

    let selectedImage = null;

    document.getElementById('imageInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          selectedImage = ev.target.result;
          log(`âœ… ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ: ${file.name}`);
          document.getElementById('testBtn').disabled = false;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('testBtn').addEventListener('click', async () => {
      if (!selectedImage) {
        log('âŒ ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
        return;
      }

      if (!GEMINI_API_KEY) {
        log('âš ï¸ Gemini API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ ì•±ì—ì„œ ì„¤ì •í•˜ì„¸ìš”.');
        log('âš ï¸ ëª¨ì…˜ í”„ë¡¬í”„íŠ¸ ìƒì„±ì„ ê±´ë„ˆë›°ê³  ì§„í–‰í•©ë‹ˆë‹¤.');
      }

      const btn = document.getElementById('testBtn');
      btn.disabled = true;
      log('ğŸš€ í…ŒìŠ¤íŠ¸ ì‹œì‘...\n');

      try {
        const dialogue = document.getElementById('dialogueInput').value;
        const imagePrompt = "A person in a room";

        // Step 1: Gemini ëª¨ì…˜ í”„ë¡¬í”„íŠ¸ ìƒì„±
        let motionDescription = "subtle natural movement, gentle expression change";
        if (GEMINI_API_KEY) {
          log('ğŸ“ Geminië¡œ ëª¨ì…˜ í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...');
          try {
            const geminiResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: `Based on this dialogue and image description, generate a motion prompt for subtle video animation.\n\nDialogue: "${dialogue}"\nImage Description: "${imagePrompt}"\n\nReturn ONLY the motion description in English, no quotes, no extra text.`
                  }]
                }]
              })
            });
            const geminiData = await geminiResponse.json();
            motionDescription = geminiData.candidates[0].content.parts[0].text.trim();
            log(`âœ… Gemini ì‘ë‹µ: ${motionDescription.substring(0, 50)}...`);
          } catch (err) {
            log(`âš ï¸ Gemini í˜¸ì¶œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©: ${err.message}`);
          }
        }

        // Step 2: Modal LTX API í˜¸ì¶œ
        const enhancedPrompt = `${imagePrompt}. ${motionDescription}`;
        log(`\nğŸ¬ Modal LTX API í˜¸ì¶œ ì¤‘...`);
        log(`   URL: ${MODAL_API}/generate`);
        log(`   Prompt: ${enhancedPrompt.substring(0, 80)}...`);

        const startTime = Date.now();
        const response = await fetch(`${MODAL_API}/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: enhancedPrompt,
            image_url: selectedImage,
            character_description: '',
            num_frames: 97
          })
        });

        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        log(`â±ï¸ ì‘ë‹µ ì‹œê°„: ${elapsed}ì´ˆ`);

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Video generation failed');
        }

        log(`âœ… Modal API ì‘ë‹µ ì„±ê³µ!`);
        log(`   Content-Type: ${response.headers.get('Content-Type')}`);
        log(`   Content-Length: ${response.headers.get('Content-Length')} bytes`);

        const videoBlob = await response.blob();
        log(`âœ… ë¹„ë””ì˜¤ Blob ìƒì„±: ${(videoBlob.size / 1024 / 1024).toFixed(2)} MB`);

        const videoUrl = URL.createObjectURL(videoBlob);
        const videoEl = document.getElementById('resultVideo');
        videoEl.src = videoUrl;
        videoEl.style.display = 'block';

        log(`\nâœ…âœ…âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ! ì•„ë˜ ë¹„ë””ì˜¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
      } catch (error) {
        log(`\nâŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        log(`   Stack: ${error.stack}`);
      } finally {
        btn.disabled = false;
      }
    });

    // ì´ˆê¸°í™”
    log('âœ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    log(`âœ… Modal API: ${MODAL_API}`);
    log(`${GEMINI_API_KEY ? 'âœ…' : 'âš ï¸'} Gemini API Key: ${GEMINI_API_KEY ? 'ì„¤ì •ë¨' : 'ì—†ìŒ'}`);
    log('\nğŸ“ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê³  í…ŒìŠ¤íŠ¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
  </script>
</body>
</html>
