<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Modal API Base64 Test</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #4F46E5; color: white; border: none; border-radius: 8px; margin: 10px 0; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #log { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-top: 20px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    video { max-width: 100%; margin-top: 20px; border: 2px solid #4F46E5; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>ğŸ¬ Modal API Base64 ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸</h1>

  <div>
    <label>ì´ë¯¸ì§€ ì„ íƒ: <input type="file" id="imageInput" accept="image/*"></label>
  </div>

  <button id="testBtn" disabled>Modal API í…ŒìŠ¤íŠ¸ (Base64)</button>

  <div id="log">ì¤€ë¹„ ì¤‘...</div>

  <video id="resultVideo" controls style="display:none;"></video>

  <script>
    const MODAL_API = 'https://hiyoonsh1--ltx-video-service-v2-ltx2-fp8-web-app.modal.run';

    const log = (msg) => {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logEl.textContent += `[${timestamp}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    };

    let selectedImageBase64 = null;

    document.getElementById('imageInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          selectedImageBase64 = ev.target.result;
          log(`âœ… ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ: ${file.name} (${(selectedImageBase64.length / 1024).toFixed(1)} KB base64)`);
          document.getElementById('testBtn').disabled = false;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('testBtn').addEventListener('click', async () => {
      if (!selectedImageBase64) {
        log('âŒ ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
        return;
      }

      const btn = document.getElementById('testBtn');
      btn.disabled = true;
      log('ğŸš€ Modal API í…ŒìŠ¤íŠ¸ ì‹œì‘...\n');

      try {
        const testPrompt = "A person standing still, subtle breathing motion, gentle expression";

        log(`ğŸ“¤ ìš”ì²­ ë°ì´í„°:`);
        log(`   - Prompt: ${testPrompt}`);
        log(`   - Image: base64 data URL (${(selectedImageBase64.length / 1024).toFixed(1)} KB)`);
        log(`   - Frames: 97`);
        log(`\nğŸŒ Modal API í˜¸ì¶œ ì¤‘...`);

        const startTime = Date.now();
        const response = await fetch(`${MODAL_API}/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: testPrompt,
            image_url: selectedImageBase64,
            character_description: '',
            num_frames: 97
          })
        });

        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        log(`â±ï¸ ì‘ë‹µ ì‹œê°„: ${elapsed}ì´ˆ`);
        log(`ğŸ“Š ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.statusText}`);
        log(`ğŸ“‹ Content-Type: ${response.headers.get('Content-Type')}`);

        if (!response.ok) {
          let errorMsg = `HTTP ${response.status}`;
          try {
            const errorData = await response.json();
            errorMsg = errorData.error || errorData.detail || errorMsg;
            log(`âŒ ì˜¤ë¥˜ (JSON): ${errorMsg}`);
          } catch (e) {
            const errorText = await response.text();
            log(`âŒ ì˜¤ë¥˜ (Text): ${errorText.substring(0, 200)}`);
          }
          throw new Error(errorMsg);
        }

        const videoBlob = await response.blob();
        log(`âœ… ë¹„ë””ì˜¤ Blob ìˆ˜ì‹ : ${(videoBlob.size / 1024 / 1024).toFixed(2)} MB`);
        log(`   MIME Type: ${videoBlob.type}`);

        const videoUrl = URL.createObjectURL(videoBlob);
        const videoEl = document.getElementById('resultVideo');
        videoEl.src = videoUrl;
        videoEl.style.display = 'block';

        log(`\nâœ…âœ…âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ! ë¹„ë””ì˜¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        log(`ğŸ“¥ ë¹„ë””ì˜¤ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ë ¤ë©´ ìš°í´ë¦­ > ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥`);
      } catch (error) {
        log(`\nâŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
        console.error('Full error:', error);
      } finally {
        btn.disabled = false;
      }
    });

    log('âœ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    log(`âœ… Modal API: ${MODAL_API}`);
    log('\nğŸ“ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê³  í…ŒìŠ¤íŠ¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
  </script>
</body>
</html>
